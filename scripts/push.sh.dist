#!/bin/bash

set -e

# Variables
ECR_REPO="${ECR_REPO:-%ECR_REPO%}"
IMAGE_NAME="atomy/nats-to-http:latest"
FULL_IMAGE_NAME="${ECR_REPO}/${IMAGE_NAME}"
BUILDER_NAME="mybuilder"

# Ensure ECR_REPO is set
if [[ -z "$ECR_REPO" ]]; then
    echo "Error: ECR_REPO is not set."
    exit 1
fi

# Check if the Buildx instance already exists
if docker buildx inspect "$BUILDER_NAME" >/dev/null 2>&1; then
    echo "Using existing Buildx instance: $BUILDER_NAME"
else
    echo "Creating Buildx instance: $BUILDER_NAME"
    docker buildx create --name "$BUILDER_NAME" --use
    docker buildx inspect --bootstrap
fi

# Push the image
echo "Preparing to push image: ${FULL_IMAGE_NAME}"
docker push "${FULL_IMAGE_NAME}"

echo "Image pushed successfully: ${FULL_IMAGE_NAME}"
